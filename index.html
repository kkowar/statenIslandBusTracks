<html class="html">
<head>
  <meta charset="UTF-8">
  <title>Hurricane</title>
  <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.css" />
  <link rel="stylesheet" href="css/leaflet.draw.css">
  <style>

  
    #map {
      height:100%;
      width: 100%;
    }

    #about {
      position: absolute;
      bottom: 10px;
      top:10px;
      left: 10px;
      background: #575757;
      margin: 15px;
      padding: 10px;
      color: #FFF;
      font-family: sans-serif;
      border-radius: 10px;
      width: 400px;
      max-height: 100%;
      overflow-y: scroll;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="about">
    <h3>Bus Ons and Offs</h3>
    <p>Ons are Blue</p>
    <p>Offs are Orange</p>
    <p>This map shows 7am Northbound passenger counts for Staten Island Buses.  The resulting polygons are generated by creating a buffer around each stop based on the number of passengers who got on/off, then generating a series of convex hulls around each successive pair of stops.  Click a route below to see its data.</p>

  </div>
  <script src="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.js"></script>
  <script src="js/leaflet.draw.js"></script>
  <script src='https://api.tiles.mapbox.com/mapbox.js/plugins/turf/v2.0.2/turf.min.js'></script>
  <script src="js/hurricane.js"></script>
  <script src="https://code.jquery.com/jquery-2.2.1.min.js"></script>
  <script type="text/javascript">




  var layer1, layer2;


    var map = L.map('map', {
      scrollWheelZoom: false,
      center: [40.630630,-74.065704],
      zoom: 11
    });

    var layer = L.tileLayer('http://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, &copy; <a href="http://cartodb.com/attributions">CartoDB</a>'
    }).addTo(map);



    function getData(routeNumber) {

      (layer1) ? map.removeLayer(layer1) : null;
      (layer2) ? map.removeLayer(layer2) : null;

        var apiCall = "https://chriswhong.cartodb.com:443/api/v2/sql?format=geojson&q=SELECT * FROM chriswhong.level_ridership_1 WHERE route = '" + routeNumber + "' AND dir = 'NB' AND hour = '7' ORDER BY  stop_sequence ASC";

    var data = $.getJSON(apiCall, function(data) {

      var startRadius = 50,
      increment = 100;

      var onTrack = makeTrack(data, 'ons');
      var offTrack = makeTrack(data, 'offs');




      layer1 = L.geoJson(onTrack,{
        style: {
            "color": "steelblue",
            "weight": 1,
            "opacity": 0.8
        }
      }).addTo(map);

      layer2 = L.geoJson(offTrack,{
        style: {
            "color": "orange",
            "weight": 1,
            "opacity": 0.8
        }
      }).addTo(map);

      map.fitBounds(layer1.getBounds());

    });
  }
  
  getData('X1');

  //set up routes list

  $.getJSON("https://chriswhong.cartodb.com:443/api/v2/sql?format=json&q=SELECT DISTINCT route FROM chriswhong.level_ridership_1 ORDER BY route ASC", function(routes) {
        console.log('routes',routes.rows);
        routes.rows.forEach(function(row) {
      $('#about').append('<p class="route">' + row.route + '</p>');
      })


    $('.route').click(function(e) {
      var thisRoute = $(e.target).text();
      getData(thisRoute)
    })
   })


  </script>
</body>
</html>